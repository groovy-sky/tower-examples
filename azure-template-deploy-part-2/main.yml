---
- hosts: localhost
  connection: local
  tasks:
    # Create a Resouce Group
    - name: Create Resource Group
      azure_rm_resourcegroup:
        state: present
        location: "{{ deploy_group_location }}"
        name: "{{ deploy_group_name }}"

    # Create or update a template deployment based on uris using parameter and template links
    - name: Create Azure Deploy
      azure_rm_deployment:
        state: present
        location: "{{ deploy_group_location }}"
        resource_group_name: "{{ deploy_group_name }}"
        parameters:
            vmadminPassword: 
              value: "{{ vm_admin_password }}"
        template_link: 'https://raw.githubusercontent.com/groovy-sky/azure/master/ansible-tower-00/azuredeploy.json'
      register: azure_deployment_results
      
    - name: Add new instance to host group
      add_host:
        hostname: "{{ azure_deployment_results.deployment.instances[0].ips[0].dns_settings.fqdn }}"
        groupname: azure_vms

- hosts: azure_vms
  tasks:
    - name: Install Nginx
        apt: pkg=nginx state=present update_cache=true
    become: yes
    become_method: sudo
    handlers:
    - name: Start Nginx
    service: name=nginx state=started
